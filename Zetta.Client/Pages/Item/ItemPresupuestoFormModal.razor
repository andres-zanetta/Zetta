@inject Zetta.Client.Servicios.ItemPresupuestoService ItemPresupuestoService
@inject IJSRuntime JSRuntime

<div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <EditForm Model="@item" OnValidSubmit="Guardar">
                <DataAnnotationsValidator />

                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-naranja">@(EsEdicion ? "Editar Ítem" : "Nuevo Ítem")</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Cerrar"></button>
                </div>

                <div class="modal-body">
                    @if (Cargando)
                    {
                        <p>Cargando datos...</p>
                    }
                    else if (Error != null)
                    {
                        <div class="alert alert-danger">@Error</div>
                    }

                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">Nombre (Producto + Espesor/Tecnología)</label>
                        <InputText @bind-Value="item.Nombre"
                                   class="form-control border-secondary"
                                   placeholder="Ej: Cable Unipolar 2.5mm / Codo 90°" />
                        <ValidationMessage For="@(() => item.Nombre)" class="text-danger" />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Precio ($) <br /> .</label>
                            <InputNumber @bind-Value="item.Precio"
                                         class="form-control border-secondary"
                                         placeholder="0.00" />
                            <ValidationMessage For="@(() => item.Precio)" class="text-danger" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Presentación / Unidad de Venta</label>
                            <InputText @bind-Value="item.Medida"
                                       class="form-control border-secondary"
                                       placeholder="Ej: 100m/Unidad/Caja x 50"/>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Material</label>
                        <InputText @bind-Value="item.Material"
                                   class="form-control border-secondary"
                                   placeholder="Ej: Cobre / PVC / Polipropileno" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción / Detalles Técnicos</label>
                        <InputTextArea @bind-Value="item.Descripcion"
                                       class="form-control border-secondary"
                                       rows="2"
                                       placeholder="Ej: Ignífugo, Normalizado IRAM, Color Rojo..." />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Marca</label>
                            <InputText @bind-Value="item.Marca"
                                       class="form-control border-secondary"
                                       placeholder="Ej: Prysmian / Tigre" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fabricante</label>
                            <InputText @bind-Value="item.Fabricante"
                                       class="form-control border-secondary"
                                       placeholder="Ej: Industrias S.A." />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha act. precio</label>
                        <InputDate @bind-Value="item.FechActuPrecio"
                                   class="form-control border-secondary" />
                    </div>

                </div>

                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="Cerrar">Cancelar</button>
                    <button type="submit" class="btn btn-naranja">
                        @(EsEdicion ? "Guardar cambios" : "Crear ítem")
                    </button>
                </div>

            </EditForm>
        </div>
    </div>
</div>
<div class="modal-backdrop fade show"></div>

@code {
    [Parameter] public int? ItemId { get; set; }
    [Parameter] public EventCallback OnCerrar { get; set; }
    [Parameter] public EventCallback<int> OnGuardado { get; set; }

    private POST_ItemPresupuestoDTO item = new() { FechActuPrecio = DateTime.Today };
    private bool EsEdicion => ItemId.HasValue;
    private bool Cargando = true;
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (EsEdicion)
            {
                var existente = await ItemPresupuestoService.GetById(ItemId.Value);
                if (existente != null)
                {
                    item = new POST_ItemPresupuestoDTO
                    {
                        Nombre = existente.Nombre,
                        Precio = existente.Precio,
                        Medida = existente.Medida,
                        Material = existente.Material,
                        Descripcion = existente.Descripcion,
                        Fabricante = existente.Fabricante,
                        Marca = existente.Marca,
                        FechActuPrecio = existente.FechActuPrecio
                    };
                }
                else
                {
                    Error = "No se encontró el ítem a editar.";
                }
            }
        }
        catch (Exception ex)
        {
            Error = $"Error al cargar datos: {ex.Message}";
        }
        finally
        {
            Cargando = false;
        }
    }

    private async Task Guardar()
    {
        try
        {
            int guardadoId = 0;
            if (EsEdicion)
            {
                var dto = new PUT_ItemPresupuestoDTO
                {
                    Nombre = item.Nombre,
                    Precio = item.Precio,
                    Medida = item.Medida,
                    Material = item.Material,
                    Descripcion = item.Descripcion,
                    Fabricante = item.Fabricante,
                    Marca = item.Marca,
                    FechActuPrecio = item.FechActuPrecio
                };
                await ItemPresupuestoService.Update(ItemId!.Value, dto);
                guardadoId = ItemId.Value;
            }
            else
            {
                await ItemPresupuestoService.Create(item);
            }

            await OnGuardado.InvokeAsync(guardadoId);
            await Cerrar();
        }
        catch (Exception ex)
        {
            Error = $"Error al guardar: {ex.Message}";
        }
    }

    private async Task Cerrar()
    {
        await OnCerrar.InvokeAsync();
    }
}