@page "/items"
@using Zetta.Shared.DTOS.ItemPresupuesto
@inject Zetta.Client.Servicios.ItemPresupuestoService ItemService
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime
@attribute [Authorize]

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <button class="btn btn-secondary me-2" @onclick="VolverAlInicio">← Volver al Menú</button>
    </div>
    <div>
        <button class="btn @(ModoPapelera ? "btn-warning" : "btn-outline-secondary") me-2"
                @onclick="ToggleModoPapelera">
            @if (ModoPapelera)
            {
                <span>📂 Ver Activos</span>
            }
            else
            {
                <span>♻️ Papelera</span>
            }
        </button>

        @if (!ModoPapelera)
        {
            <button class="btn btn-outline-warning me-2" @onclick="AbrirModalAumento">
                📈 Actualizar Precios
            </button>
            <button class="btn btn-naranja" @onclick="AbrirFormularioNuevo">➕ Nuevo Ítem</button>
        }
    </div>
</div>

<div class="clientes-container">
    <header class="clientes-header text-center mb-4">
        <h1>@(ModoPapelera ? "Papelera de Reciclaje" : "Gestión de Ítems de Presupuesto")</h1>
        <p class="subtitle">
            @(ModoPapelera ? "Recuperá ítems eliminados anteriormente." : "Configurá y administrá los ítems base de tus presupuestos.")
        </p>
    </header>

    @* FILTROS *@
    <div class="filtros-container mb-5 p-3 rounded shadow-sm">
        <h5 class="mb-3">
            <i class="bi bi-funnel"></i> 🔍 Filtrar ítems
        </h5>

        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <input type="text"
                       class="form-control bg-dark text-white border-warning"
                       placeholder="Buscar por nombre o descripción..."
                       @bind="SearchTerm"
                       @bind:event="oninput" />
            </div>

            <div class="col-md-3">
                <select class="form-select bg-dark text-white border-warning"
                        @bind="SelectedFabricante"
                        @bind:event="onchange">
                    <option value="">Todos los fabricantes</option>
                    @foreach (var fab in FabricantesDisponibles)
                    {
                        <option value="@fab">@fab</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <select class="form-select bg-dark text-white border-warning"
                        @bind="SelectedMarca"
                        @bind:event="onchange">
                    <option value="">Todas las marcas</option>
                    @foreach (var marca in MarcasDisponibles)
                    {
                        <option value="@marca">@marca</option>
                    }
                </select>
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-dark w-100 text-white border-white" @onclick="ResetFilters">Limpiar</button>
            </div>

            <div class="col-md-1 text-muted">
                @($"{PresupuestoItems.Count} ítems")
            </div>
        </div>
    </div>

    @if (Cargando)
    {
        <p>Cargando ítems...</p>
    }
    else
    {
        <div class="table-responsive shadow-sm">
            <table class="table align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Medida</th>
                        <th>Descripción</th>
                        <th>Fabricante</th>
                        <th>Marca</th>
                        <th>Fecha act Precio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (PresupuestoItems.Any())
                    {
                        @foreach (var item in PresupuestoItems)
                        {
                            <tr class="@(ModoPapelera ? "table-secondary text-muted" : "")">
                                <td>@item.Nombre</td>
                                <td>@item.Precio.ToString("C", new System.Globalization.CultureInfo("es-AR"))</td>
                                <td>@item.Medida</td>
                                <td>@item.Descripcion</td>
                                <td>@item.Fabricante</td>
                                <td>@item.Marca</td>
                                <td>@(item.FechActuPrecio.HasValue? item.FechActuPrecio.Value.ToString("dd/MM/yyyy") : "-")</td>
                                <td>
                                    @if (ModoPapelera)
                                    {
                                        // ACCIÓN RESTAURAR (Solo en papelera)
                                        <button class="btn btn-sm btn-success" title="Restaurar Ítem" @onclick="() => RestaurarItem(item.Id)">
                                            <i class="bi bi-arrow-counterclockwise"></i> Restaurar
                                        </button>
                                    }
                                    else
                                    {
                                        // ACCIONES NORMALES (Editar / Eliminar)
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                title="Editar Item" @onclick="() => AbrirFormularioEdicion(item.Id)">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" title="Eliminar Item" @onclick="() => EliminarItem(item.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                @(ModoPapelera ? "La papelera está vacía." : "No se encontraron ítems.")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* Modal de Creación/Edición de Ítem *@
    @if (MostrarItemModal)
    {
        <ItemPresupuestoFormModal ItemId="ItemIdParaEditar"
                                  OnCerrar="CerrarItemModal"
                                  OnGuardado="ItemGuardado" />
    }

    @* --- MODAL DE AUMENTO MASIVO --- *@
    @if (MostrarModalAumento)
    {
        <div class="modal d-block" style="background: rgba(0,0,0,0.8)">
            <div class="modal-dialog">
                <div class="modal-content border-warning">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-naranja">Actualización Masiva de Precios</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => MostrarModalAumento = false"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>Atención:</strong> Esta acción modificará el precio de múltiples ítems permanentemente.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Filtrar por Marca (Dejar vacío para todos)</label>
                            <select class="form-select bg-dark text-white border-secondary" @bind="AumentoDto.Marca">
                                <option value="">-- Todas las Marcas --</option>
                                @foreach (var m in MarcasDisponibles)
                                {
                                    <option value="@m">@m</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Porcentaje de Ajuste (%)</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary"
                                   @bind="AumentoDto.Porcentaje"
                                   placeholder="Ej: 15 para aumento, -10 para descuento" />
                            <small class="text-muted mt-1 d-block">
                                <i class="bi bi-info-circle"></i> Use números <b>negativos</b> para bajar precios (ej: -10).
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button class="btn btn-secondary" @onclick="() => MostrarModalAumento = false">Cancelar</button>
                        <button class="btn btn-warning" @onclick="ConfirmarAumento">Aplicar Ajuste</button>
                    </div>
                </div>
            </div>
        </div>
    }

</div>

@code {
    private List<GET_ItemPresupuestoDTO> AllItems { get; set; } = new();
    private List<GET_ItemPresupuestoDTO> PresupuestoItems { get; set; } = new();
    private bool Cargando = true;
    private bool ModoPapelera = false; // Controla si vemos activos o eliminados

    // --- Filtros ---
    private string _searchTerm = string.Empty;
    private string SearchTerm
    {
        get => _searchTerm;
        set
        {
            if (_searchTerm != value)
            {
                _searchTerm = value;
                FilterItems();
            }
        }
    }

    private string _selectedFabricante = string.Empty;
    private string SelectedFabricante
    {
        get => _selectedFabricante;
        set
        {
            if (_selectedFabricante != value)
            {
                _selectedFabricante = value;
                FilterItems();
            }
        }
    }

    private string _selectedMarca = string.Empty;
    private string SelectedMarca
    {
        get => _selectedMarca;
        set
        {
            if (_selectedMarca != value)
            {
                _selectedMarca = value;
                FilterItems();
            }
        }
    }

    private List<string> FabricantesDisponibles { get; set; } = new();
    private List<string> MarcasDisponibles { get; set; } = new();

    // Estado para el modal de Ítem
    private bool MostrarItemModal = false;
    private int? ItemIdParaEditar = null;

    // Estado para modal de Aumento Masivo
    private bool MostrarModalAumento = false;
    private POST_AumentoMasivoDTO AumentoDto = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarItems();
    }

    private async Task ToggleModoPapelera()
    {
        ModoPapelera = !ModoPapelera;
        // Limpiamos filtros al cambiar de modo para evitar confusión
        SearchTerm = "";
        SelectedFabricante = "";
        SelectedMarca = "";
        await CargarItems();
    }

    private async Task CargarItems()
    {
        Cargando = true;
        try
        {
            if (ModoPapelera)
            {
                // Cargar ítems eliminados
                AllItems = await ItemService.GetInactivos() ?? new List<GET_ItemPresupuestoDTO>();
            }
            else
            {
                // Cargar ítems activos (comportamiento normal)
                AllItems = await ItemService.GetAll() ?? new List<GET_ItemPresupuestoDTO>();
            }

            // Actualizar listas de filtros según lo que se cargó (activos o inactivos)
            ActualizarListasFiltros();

            FilterItems(); // Aplica filtros iniciales
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar ítems: {ex.Message}");
            AllItems = new List<GET_ItemPresupuestoDTO>();
            PresupuestoItems = new List<GET_ItemPresupuestoDTO>();
            FabricantesDisponibles = new();
            MarcasDisponibles = new();
        }
        Cargando = false;
    }

    private void ActualizarListasFiltros()
    {
        FabricantesDisponibles = AllItems
            .Where(i => !string.IsNullOrWhiteSpace(i.Fabricante))
            .Select(i => i.Fabricante!)
            .Distinct()
            .OrderBy(x => x)
            .ToList();

        MarcasDisponibles = AllItems
            .Where(i => !string.IsNullOrWhiteSpace(i.Marca))
            .Select(i => i.Marca!)
            .Distinct()
            .OrderBy(x => x)
            .ToList();
    }

    private void FilterItems()
    {
        IEnumerable<GET_ItemPresupuestoDTO> query = AllItems;

        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            var s = SearchTerm.Trim().ToLowerInvariant();
            query = query.Where(i =>
                (!string.IsNullOrEmpty(i.Nombre) && i.Nombre.ToLowerInvariant().Contains(s)) ||
                (!string.IsNullOrEmpty(i.Descripcion) && i.Descripcion.ToLowerInvariant().Contains(s))
            );
        }

        if (!string.IsNullOrWhiteSpace(SelectedFabricante))
        {
            query = query.Where(i =>
                !string.IsNullOrEmpty(i.Fabricante) &&
                i.Fabricante.Equals(SelectedFabricante, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(SelectedMarca))
        {
            query = query.Where(i =>
                !string.IsNullOrEmpty(i.Marca) &&
                i.Marca.Equals(SelectedMarca, StringComparison.OrdinalIgnoreCase));
        }

        PresupuestoItems = query.ToList();
        StateHasChanged();
    }

    private void ResetFilters()
    {
        SearchTerm = string.Empty;
        SelectedFabricante = string.Empty;
        SelectedMarca = string.Empty;
        PresupuestoItems = AllItems.ToList();
        StateHasChanged();
    }

    private async Task EliminarItem(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Estás seguro de que quieres eliminar este ítem?"))
        {
            try
            {
                await ItemService.Delete(id); // Esto ahora hace Soft Delete en el server
                // Lo sacamos de la lista visual actual
                AllItems.RemoveAll(i => i.Id == id);
                PresupuestoItems.RemoveAll(i => i.Id == id);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al eliminar ítem {id}: {ex.Message}");
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo eliminar el ítem.");
            }
        }
    }

    private async Task RestaurarItem(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Desea restaurar este ítem al catálogo activo?"))
        {
            try
            {
                await ItemService.Restaurar(id);
                // Al restaurar, desaparece de la lista de "Papelera"
                AllItems.RemoveAll(i => i.Id == id);
                PresupuestoItems.RemoveAll(i => i.Id == id);
                StateHasChanged();
                await JSRuntime.InvokeVoidAsync("alert", "✅ Ítem recuperado exitosamente.");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error al restaurar: {ex.Message}");
            }
        }
    }

    // --- Modal Ítem ---
    private void AbrirFormularioNuevo()
    {
        ItemIdParaEditar = null;
        MostrarItemModal = true;
    }

    private void AbrirFormularioEdicion(int id)
    {
        ItemIdParaEditar = id;
        MostrarItemModal = true;
    }

    private void CerrarItemModal()
    {
        MostrarItemModal = false;
        ItemIdParaEditar = null;
    }

    private async Task ItemGuardado(int itemId)
    {
        CerrarItemModal();
        await CargarItems(); // Recarga toda la lista para ver cambios/nuevos
    }

    // --- Modal Aumento Masivo ---
    private void AbrirModalAumento()
    {
        AumentoDto = new POST_AumentoMasivoDTO();
        MostrarModalAumento = true;
    }

    private async Task ConfirmarAumento()
    {
        string target = string.IsNullOrEmpty(AumentoDto.Marca) ? "TODOS los ítems" : $"los ítems de marca '{AumentoDto.Marca}'";
        string accion = AumentoDto.Porcentaje >= 0 ? "AUMENTAR" : "DESCONTAR";

        if (await JSRuntime.InvokeAsync<bool>("confirm", $"¿Estás seguro de que querés {accion} un {Math.Abs(AumentoDto.Porcentaje)}% a {target}?"))
        {
            try
            {
                await ItemService.AplicarAumento(AumentoDto);
                MostrarModalAumento = false;
                await CargarItems(); // Recargar la tabla para ver los precios nuevos
                await JSRuntime.InvokeVoidAsync("alert", "✅ Precios actualizados correctamente.");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"❌ Error al actualizar precios: {ex.Message}");
            }
        }
    }

    private void VolverAlInicio() => Navigation.NavigateTo("/");
}