@page "/clientes"
@inject Zetta.Client.Servicios.IClienteService ClienteService
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <button class="btn btn-secondary me-2" @onclick="VolverAlInicio">← Volver al Menú</button>
    </div>
    <div>
        <button class="btn @(ModoPapelera ? "btn-warning" : "btn-outline-secondary") me-2"
                @onclick="ToggleModoPapelera">
            @if (ModoPapelera)
            {
                <span>📂 Ver Activos</span>
            }
            else
            {

                <span>♻️ Papelera</span>
            }
        </button>

        @if (!ModoPapelera)
        {
            <button class="btn btn-naranja" @onclick="AbrirModalNuevo">➕ Nuevo Cliente</button>
        }
    </div>
</div>

<div class="clientes-container">
    <header class="clientes-header text-center">
        <h1>@(ModoPapelera ? "Papelera de Clientes" : "Gestión de Clientes")</h1>
        <p class="subtitle">@(ModoPapelera ? "Recuperá clientes eliminados o borralos definitivamente." : "Administrá la información de tus clientes")</p>
    </header>

    <div class="filtros-container mb-4 p-3 rounded shadow-sm">
        <h5 class="mb-3">🔍 Filtrar clientes</h5>
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <input type="text" class="form-control shadow-sm bg-dark text-white border-secondary"
                       placeholder="Buscar por nombre o apellido..."
                       @bind="SearchTerm" @oninput="OnSearchInput" />
            </div>
            <div class="col-md-4">
                <select class="form-select shadow-sm bg-dark text-white border-secondary"
                        value="@SelectedLocalidad" @onchange="OnLocalidadChanged">
                    <option value="">Todas las localidades</option>
                    @foreach (var loc in LocalidadesDisponibles)
                    {
                        <option value="@loc">@loc</option>
                    }
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-outline-dark w-100 text-white border-white" @onclick="ResetFilters">Limpiar</button>
            </div>
        </div>
    </div>

    @if (Cargando)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-3">Cargando clientes...</p>
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm">
            <table class="table align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Teléfono</th>
                        <th>Email</th>
                        <th>Localidad</th>
                        <th>Direccion</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (ClientesFiltrados.Any())
                    {
                        @foreach (var cliente in ClientesFiltrados)
                        {
                            <tr class="@(ModoPapelera ? "table-secondary text-muted" : "")">
                                <td>@cliente.Nombre</td>
                                <td>@cliente.Apellido</td>
                                <td>@cliente.Telefono</td>
                                <td>@cliente.Email</td>
                                <td>@cliente.Localidad</td>
                                <td>@cliente.Direccion</td>
                                <td>
                                    @if (ModoPapelera)
                                    {
                                        <button class="btn btn-sm btn-success me-1" title="Restaurar" @onclick="() => RestaurarCliente(cliente.Id)">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" title="Eliminar Definitivamente" @onclick="() => EliminarDefinitivo(cliente.Id)">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => AbrirModalEditar(cliente)"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" title="Mover a Papelera" @onclick="() => EliminarCliente(cliente.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted">@(ModoPapelera ? "La papelera está vacía." : "No se encontraron clientes.")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* Modal (Solo se muestra si NO estamos en modo papelera) *@
    @if (MostrarModal)
    {
        <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-white border-warning">
                    <EditForm Model="@ClienteActual" OnValidSubmit="@GuardarCliente">
                        <DataAnnotationsValidator />
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title text-naranja">@(Editando ? "Editar Cliente" : "Nuevo Cliente")</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                        </div>
                        <div class="modal-body">
                            <ValidationSummary class="text-danger" />
                            <div class="mb-3"> <label class="form-label">Nombre</label> <InputText @bind-Value="ClienteActual.Nombre" class="form-control bg-black text-white border-secondary" /> </div>
                            <div class="mb-3"> <label class="form-label">Apellido</label> <InputText @bind-Value="ClienteActual.Apellido" class="form-control bg-black text-white border-secondary" /> </div>
                            <div class="mb-3"> <label class="form-label">Teléfono</label> <InputText @bind-Value="ClienteActual.Telefono" class="form-control bg-black text-white border-secondary" maxlength="10" /> <ValidationMessage For="@(() => ClienteActual.Telefono)" /> </div>
                            <div class="mb-3"> <label class="form-label">Email</label> <InputText @bind-Value="ClienteActual.Email" class="form-control bg-black text-white border-secondary" /> </div>
                            <div class="mb-3"> <label class="form-label">Localidad</label> <InputText @bind-Value="ClienteActual.Localidad" class="form-control bg-black text-white border-secondary" /> </div>
                            <div class="mb-3"> <label class="form-label">Dirección</label> <InputText @bind-Value="ClienteActual.Direccion" class="form-control bg-black text-white border-secondary" /> </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                            <button type="submit" class="btn btn-naranja">Guardar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
</div>

@code {
    private List<GET_ClienteDTO> Clientes = new List<GET_ClienteDTO>();
    private List<GET_ClienteDTO> ClientesFiltrados = new();
    private List<string> LocalidadesDisponibles = new();
    private ClienteFormModel ClienteActual = new ClienteFormModel();
    private bool MostrarModal = false;
    private bool Editando = false;
    private bool Cargando = true;

    // --- Control de Papelera ---
    private bool ModoPapelera = false;

    // Filtros
    private string _searchTerm = string.Empty;
    private string SearchTerm { get => _searchTerm; set { _searchTerm = value ?? string.Empty; FiltrarClientes(); } }
    private string _selectedLocalidad = string.Empty;
    private string SelectedLocalidad { get => _selectedLocalidad; set { _selectedLocalidad = value ?? string.Empty; FiltrarClientes(); } }

    public class ClienteFormModel
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = "";
        public string Apellido { get; set; } = "";
        [Required(ErrorMessage = "El teléfono es obligatorio.")]
        [RegularExpression(@"^351\d{7}$", ErrorMessage = "El teléfono debe comenzar con 351 y tener 10 dígitos.")]
        public string Telefono { get; set; } = "";
        [Required(ErrorMessage = "El email es obligatorio.")]
        [RegularExpression(@"^[^@\s]+@[^@\s]+\.[a-zA-Z]{2,}$", ErrorMessage = "Debe ingresar un correo válido")]
        public string? Email { get; set; }
        public string? Localidad { get; set; }
        public string? Direccion { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes();
    }

    private async Task ToggleModoPapelera()
    {
        ModoPapelera = !ModoPapelera;
        SearchTerm = "";
        SelectedLocalidad = "";
        await CargarClientes();
    }

    private async Task CargarClientes()
    {
        Cargando = true;
        try
        {
            if (ModoPapelera)
            {
                var serviceConcreto = (Zetta.Client.Servicios.ClienteService)ClienteService;
                Clientes = await serviceConcreto.GetInactivos() ?? new List<GET_ClienteDTO>();
            }
            else
            {
                Clientes = await ClienteService.GetAll() ?? new List<GET_ClienteDTO>();
            }

            // Actualizar localidades para filtros según la lista cargada
            LocalidadesDisponibles = Clientes.Where(c => !string.IsNullOrWhiteSpace(c.Localidad)).Select(c => c.Localidad!).Distinct().OrderBy(x => x).ToList();
            FiltrarClientes();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Clientes = new List<GET_ClienteDTO>();
            ClientesFiltrados = new();
        }
        Cargando = false;
    }

    private void OnSearchInput(ChangeEventArgs e) { SearchTerm = e.Value?.ToString() ?? string.Empty; FiltrarClientes(); }
    private void OnLocalidadChanged(ChangeEventArgs e) { SelectedLocalidad = e.Value?.ToString() ?? string.Empty; FiltrarClientes(); }

    private void FiltrarClientes()
    {
        var termino = SearchTerm?.Trim() ?? string.Empty;
        ClientesFiltrados = Clientes
            .Where(c => (string.IsNullOrEmpty(termino) || (!string.IsNullOrEmpty(c.Nombre) && c.Nombre.Contains(termino, StringComparison.OrdinalIgnoreCase)) || (!string.IsNullOrEmpty(c.Apellido) && c.Apellido.Contains(termino, StringComparison.OrdinalIgnoreCase))) &&
                        (string.IsNullOrEmpty(SelectedLocalidad) || c.Localidad == SelectedLocalidad))
            .ToList();
    }

    private void ResetFilters() { SearchTerm = string.Empty; SelectedLocalidad = string.Empty; ClientesFiltrados = Clientes.ToList(); }

    private void AbrirModalNuevo() { ClienteActual = new ClienteFormModel(); Editando = false; MostrarModal = true; }
    private void AbrirModalEditar(GET_ClienteDTO cliente)
    {
        ClienteActual = new ClienteFormModel { Id = cliente.Id, Nombre = cliente.Nombre, Apellido = cliente.Apellido, Telefono = cliente.Telefono, Email = cliente.Email, Localidad = cliente.Localidad, Direccion = cliente.Direccion };
        Editando = true; MostrarModal = true;
    }

    private async Task GuardarCliente()
    {
        try
        {
            if (Editando)
            {
                var putDto = new PUT_ClienteDTO { Id = ClienteActual.Id, Nombre = ClienteActual.Nombre, Apellido = ClienteActual.Apellido, Telefono = ClienteActual.Telefono, Email = ClienteActual.Email, Localidad = ClienteActual.Localidad, Direccion = ClienteActual.Direccion };
                await ClienteService.Update(ClienteActual.Id, putDto);
            }
            else
            {
                var postDto = new POST_ClienteDTO { Nombre = ClienteActual.Nombre, Apellido = ClienteActual.Apellido, Telefono = ClienteActual.Telefono, Email = ClienteActual.Email, Localidad = ClienteActual.Localidad, Direccion = ClienteActual.Direccion };
                await ClienteService.Create(postDto);
            }
            CerrarModal();
            await CargarClientes();
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
    }

    private async Task EliminarCliente(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Mover a la papelera?"))
        {
            try { await ClienteService.Delete(id); await CargarClientes(); } catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        }
    }

    private async Task RestaurarCliente(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Restaurar este cliente?"))
        {
            try
            {
                var serviceConcreto = (Zetta.Client.Servicios.ClienteService)ClienteService;
                await serviceConcreto.Restaurar(id);
                await CargarClientes();
            }
            catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        }
    }

    private async Task EliminarDefinitivo(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "⚠️ ¿Eliminar DEFINITIVAMENTE? Esta acción no se puede deshacer."))
        {
            try
            {
                var serviceConcreto = (Zetta.Client.Servicios.ClienteService)ClienteService;
                await serviceConcreto.EliminarDefinitivamente(id);
                await CargarClientes();
            }
            catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        }
    }

    private void CerrarModal() => MostrarModal = false;
    private void VolverAlInicio() => Navigation.NavigateTo("/");
}