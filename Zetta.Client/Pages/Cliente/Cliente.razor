@page "/clientes"
@using System.ComponentModel.DataAnnotations
@inject Zetta.Client.Servicios.IClienteService ClienteService
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-secondary" @onclick="VolverAlInicio">← Volver al Menú</button>
    <button class="btn btn-naranja" @onclick="AbrirModalNuevo">➕ Nuevo Cliente</button>
</div>


<div class="clientes-container">
    <header class="clientes-header text-center">
        <h1>Gestión de Clientes</h1>
        <p class="subtitle">Administrá la información de tus clientes</p>
    </header>

    <!-- 🔍 FILTROS DE CLIENTES -->
    <div class="filtros-container mb-4 p-3 rounded shadow-sm">
        <h5 class="mb-3">🔍 Filtrar clientes</h5>

        <div class="row g-3 align-items-end">
            <!-- Buscar por nombre o apellido -->
            <div class="col-md-4">
                <input type="text"
                       class="form-control shadow-sm"
                       placeholder="Buscar por nombre o apellido..."
                       @bind="SearchTerm"
                       @oninput="OnSearchInput" />
            </div>

            <!-- Filtrar por localidad -->
            <div class="col-md-4">
                <select class="form-select shadow-sm"
                        value="@SelectedLocalidad"
                        @onchange="OnLocalidadChanged">
                    <option value="">Todas las localidades</option>
                    @foreach (var loc in LocalidadesDisponibles)
                    {
                        <option value="@loc">@loc</option>
                    }
                </select>
            </div>

            <!-- Botones de acción -->
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-outline-dark w-100 text-white border-white" @onclick="ResetFilters">
                    Limpiar
                </button>
            </div>
        </div>
    </div>

    @if (Cargando)
    {
        <p>Cargando clientes...</p>
    }
    else
    {
        <div class="table-responsive shadow-sm">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Teléfono</th>
                        <th>Email</th>
                        <th>Localidad</th>
                        <th>Direccion</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cliente in ClientesFiltrados)

                    {
                        <tr>
                            <td>@cliente.Nombre</td>
                            <td>@cliente.Apellido</td>
                            <td>@cliente.Telefono</td>
                            <td>@cliente.Email</td>
                            <td>@cliente.Localidad</td>
                            <td>@cliente.Direccion</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => AbrirModalEditar(cliente)"><i class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-sm btn-outline-danger" title="Eliminar Cliente"
                                        @onclick="() => EliminarCliente(cliente.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* Modal de Creación/Edición *@
    @if (MostrarModal)
    {
        <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <EditForm Model="@ClienteActual" OnValidSubmit="@GuardarCliente">
                        @* Usamos ClienteActual como Model *@
                        <DataAnnotationsValidator />
                        <div class="modal-header">
                            <h5 class="modal-title">@(Editando ? "Editar Cliente" : "Nuevo Cliente")</h5>
                            <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                        </div>
                        <div class="modal-body">
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Nombre</label>
                                <InputText @bind-Value="ClienteActual.Nombre" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Apellido</label>
                                <InputText @bind-Value="ClienteActual.Apellido" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Teléfono</label>
                                <InputText @bind-Value="ClienteActual.Telefono"
                                           class="form-control"
                                           inputmode="numeric"
                                           pattern="^[0-9]*$"
                                           maxlength="10" />
                                <ValidationMessage For="@(() => ClienteActual.Telefono)" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <InputText @bind-Value="ClienteActual.Email" class="form-control" />
                           
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Localidad</label>
                                <InputText @bind-Value="ClienteActual.Localidad" class="form-control" />
                            </div>
                            @* Agregamos Direccion, ya que está en los DTOs *@
                            <div class="mb-3">
                                <label class="form-label">Dirección</label>
                                <InputText @bind-Value="ClienteActual.Direccion" class="form-control" />
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
</div>


@code {
    // La lista ahora usa el DTO de lectura
    private List<GET_ClienteDTO> Clientes = new List<GET_ClienteDTO>();
    private List<GET_ClienteDTO> ClientesFiltrados = new();
    private List<string> LocalidadesDisponibles = new();

    // modelo intermedio para el formulario, incluyendo el Id para edición.
    private ClienteFormModel ClienteActual = new ClienteFormModel();
    private bool MostrarModal = false;
    private bool Editando = false;
    private bool Cargando = true;

    // Filtros
    private string _searchTerm = string.Empty;
    private string SearchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value ?? string.Empty;
            FiltrarClientes();
        }
    }

    private string _selectedLocalidad = string.Empty;
    private string SelectedLocalidad
    {
        get => _selectedLocalidad;
        set
        {
            _selectedLocalidad = value ?? string.Empty;
            FiltrarClientes();
        }
    }

 
    // Modelo intermedio para el formulario de cliente
    public class ClienteFormModel
    {
        public int Id { get; set; } // Id es necesario solo para identificar en edición
        public string Nombre { get; set; } = "";
        public string Apellido { get; set; } = "";
        [Required(ErrorMessage = "El teléfono es obligatorio.")]
        [RegularExpression(@"^351\d{7}$",
        ErrorMessage = "El teléfono debe comenzar con 351 y tener 10 dígitos (ej: 3515909859).")]
        public string Telefono { get; set; } = "";
        [Required(ErrorMessage = "El email es obligatorio.")]
        [RegularExpression(@"^[^@\s]+@[^@\s]+\.[a-zA-Z]{2,}$",
        ErrorMessage = "Debe ingresar un correo válido (ejemplo: usuario@dominio.com)")]
        public string? Email { get; set; }
        public string? Localidad { get; set; }
        public string? Direccion { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes();
        InicializarFiltros();
    }

    #region METODOS
    private async Task CargarClientes()
    {
        Cargando = true;
        try
        {
            // Llama al servicio para obtener los datos de la API
            Clientes = await ClienteService.GetAll() ?? new List<GET_ClienteDTO>();
            ClientesFiltrados = Clientes;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar clientes: {ex.Message}");
            Clientes = new List<GET_ClienteDTO>();
            ClientesFiltrados = new();
        }
        Cargando = false;
    }

    private void InicializarFiltros()
    {
        LocalidadesDisponibles = Clientes
            .Where(c => !string.IsNullOrWhiteSpace(c.Localidad))
            .Select(c => c.Localidad!)
            .Distinct()
            .OrderBy(x => x)
            .ToList();

        // Al iniciar, mostramos todo aplicado a los filtros vacíos
        FiltrarClientes();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        SearchTerm = e.Value?.ToString() ?? string.Empty;
        FiltrarClientes();
    }

    private void OnLocalidadChanged(ChangeEventArgs e)
    {
        SelectedLocalidad = e.Value?.ToString() ?? string.Empty;
        FiltrarClientes();
    }
 
    private void FiltrarClientes()
    {
        var termino = SearchTerm?.Trim() ?? string.Empty;

        ClientesFiltrados = Clientes
            .Where(c =>
                (string.IsNullOrEmpty(termino) ||
                 (!string.IsNullOrEmpty(c.Nombre) &&
                  c.Nombre.Contains(termino, StringComparison.OrdinalIgnoreCase)) ||
                 (!string.IsNullOrEmpty(c.Apellido) &&
                  c.Apellido.Contains(termino, StringComparison.OrdinalIgnoreCase))) &&
                (string.IsNullOrEmpty(SelectedLocalidad) ||
                 c.Localidad == SelectedLocalidad))
            .ToList();
    }

    private void ResetFilters()
    {
        SearchTerm = string.Empty;
        SelectedLocalidad = string.Empty;
        ClientesFiltrados = Clientes.ToList();
    }

    private void ValidarEmail(ChangeEventArgs e)
    {
        ClienteActual.Email = e.Value?.ToString();
    }


    private void AbrirModalNuevo()
    {
        // Inicializa un nuevo modelo
        ClienteActual = new ClienteFormModel();
        Editando = false;
        MostrarModal = true;
    }

    private void AbrirModalEditar(GET_ClienteDTO cliente)
    {
        // Mapea el DTO de la tabla al modelo del formulario
        ClienteActual = new ClienteFormModel
        {
            Id = cliente.Id,
            Nombre = cliente.Nombre,
            Apellido = cliente.Apellido,
            Telefono = cliente.Telefono,
            Email = cliente.Email,
            Localidad = cliente.Localidad,
            Direccion = cliente.Direccion
        };
        Editando = true;
        MostrarModal = true;
    }

    private async Task GuardarCliente()
    {
        try
        {
            if (Editando)
            {
                // Mapea el modelo del formulario al DTO de edición
                var putDto = new PUT_ClienteDTO
                {
                    Id = ClienteActual.Id, // El ID es obligatorio en PUT_ClienteDTO
                    Nombre = ClienteActual.Nombre,
                    Apellido = ClienteActual.Apellido,
                    Telefono = ClienteActual.Telefono,
                    Email = ClienteActual.Email,
                    Localidad = ClienteActual.Localidad,
                    Direccion = ClienteActual.Direccion
                };
                await ClienteService.Update(ClienteActual.Id, putDto);
            }
            else
            {
                // Mapea el modelo del formulario al DTO de creación
                var postDto = new POST_ClienteDTO
                {
                    Nombre = ClienteActual.Nombre,
                    Apellido = ClienteActual.Apellido,
                    Telefono = ClienteActual.Telefono,
                    Email = ClienteActual.Email,
                    Localidad = ClienteActual.Localidad,
                    Direccion = ClienteActual.Direccion
                };
                await ClienteService.Create(postDto);
            }

            CerrarModal();
            await CargarClientes(); // Recarga la lista para mostrar el cambio
            FiltrarClientes(); // Actualiza la vista con los filtros activos
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al guardar cliente: {ex.Message}");
        }
    }

    private async Task EliminarCliente(int id)
    {
        // Pide confirmación antes de eliminar
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Estás seguro de que quieres eliminar este cliente?"))
        {
            try
            {
                await ClienteService.Delete(id);
                // Si la eliminación fue exitosa, eliminamos de la lista local
                Clientes.RemoveAll(c => c.Id == id);
                FiltrarClientes();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al eliminar cliente {id}: {ex.Message}");
            }
        }
    }

    private void CerrarModal() => MostrarModal = false;

    private void VolverAlInicio()
    {
        Navigation.NavigateTo("/");
    }
    #endregion
}