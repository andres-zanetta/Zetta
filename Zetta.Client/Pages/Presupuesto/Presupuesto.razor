@page "/presupuestos"
@inject Zetta.Client.Servicios.IPresupuestoServices PresupuestoService
@inject Zetta.Client.Servicios.IObraService ObraService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@attribute [Authorize]

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <button class="btn btn-secondary me-2" @onclick="VolverAlInicio">← Volver al Menú</button>
    </div>
    <div>
        <button class="btn @(ModoPapelera ? "btn-warning" : "btn-outline-secondary") me-2" @onclick="ToggleModoPapelera">
            @if (ModoPapelera)
            {
                <span>📂 Ver Activos</span>
            }
            else
            {

                <span>♻️ Papelera</span>
            }
        </button>
        @if (!ModoPapelera)
        {
            <button class="btn btn-naranja" @onclick="AbrirFormularioNuevo">➕ Nuevo Presupuesto</button>
        }
    </div>
</div>

<div class="clientes-container">
    <header class="clientes-header text-center mb-4">
        <h1>@(ModoPapelera ? "Papelera de Presupuestos" : "Gestión de Presupuestos")</h1>
        <p class="subtitle">@(ModoPapelera ? "Recuperá o eliminá definitivamente." : "Administrá, controlá y generá presupuestos.")</p>
    </header>

    <div class="filtros-container mb-4 p-3 bg-black rounded shadow-sm">
        <h5 class="mb-3">🔍 Filtrar</h5>
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control bg-dark text-white border-warning" placeholder="Buscar por cliente..." @bind="FiltroCliente" @bind:event="oninput" />
            </div>
            <div class="col-md-3">
                <select class="form-select bg-dark text-white border-warning" @bind="FiltroRubro">
                    <option value="">Todos los rubros</option>
                    @foreach (var rubro in RubrosDisponibles)
                    {
                        <option value="@rubro">@rubro</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select bg-dark text-white border-warning" @bind="FiltroEstado">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Aceptado">Aceptado</option>
                    <option value="En Obra">En Obra</option>
                    <option value="Vencido">Vencido</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select bg-dark text-white border-warning" @bind="FiltroPago">
                    <option value="">Todas las opciones</option>
                    <option value="MercadoPago">MercadoPago</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Cuenta Link">Cuenta Link</option>
                    <option value="Contado">Contado</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-dark w-100 text-white border-white" @onclick="LimpiarFiltros">Limpiar</button>
            </div>
        </div>
    </div>

    @if (Cargando)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-3">Cargando...</p>
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm">
            <table class="table align-middle">
                <thead class="table-dark">
                    <tr>
                        <th class="visually-hidden">ID</th>
                        <th>Cliente</th>
                        <th>Rubro</th>
                        <th>Opción de Pago</th>
                        <th>Total Final</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Presupuestos == null || Presupuestos.Count == 0)
                    {
                        <tr><td colspan="7" class="text-center text-muted">@(ModoPapelera ? "Papelera vacía." : "No hay presupuestos.")</td></tr>
                    }
                    else
                    {
                        @foreach (var p in Presupuestos)
                        {
                            <tr class="@(ModoPapelera ? "table-secondary text-muted" : "")">
                                <td class="visually-hidden">@p.Id</td>
                                <td>@p.NombreCliente</td>
                                <td>@p.RubroNombre</td>
                                <td>@p.OpcionDePago</td>
                                <td class="fw-bold">$ @p.Total.ToString("N2")</td>
                                <td>
                                    @{
                                        var estado = GetEstadoPresupuesto(p);
                                    }
                                    <span class="@estado.BadgeClass">@estado.Status</span>
                                </td>
                                <td class="text-center">
                                    @if (ModoPapelera)
                                    {
                                        <button class="btn btn-sm btn-success me-1" title="Restaurar" @onclick="() => RestaurarPresupuesto(p.Id)">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" title="Eliminar Definitivamente" @onclick="() => EliminarDefinitivo(p.Id)">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-primary me-1" title="Editar" @onclick="() => AbrirFormularioEdicion(p.Id)"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-outline-info me-1" title="PDF" @onclick="() => GenerarPdfCliente(p)"><i class="bi bi-download"></i></button>
                                        <button class="btn btn-sm btn-outline-danger" title="Papelera" @onclick="() => EliminarPresupuesto(p.Id)"><i class="bi bi-trash"></i></button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<GET_PresupuestoDTO> Presupuestos { get; set; } = new();
    private List<GET_PresupuestoDTO> PresupuestosOriginales { get; set; } = new();
    private List<GET_ObraDTO> Obras { get; set; } = new();
    private bool Cargando = true;
    private bool ModoPapelera = false;

    private string _filtroCliente = string.Empty;
    private string FiltroCliente { get => _filtroCliente; set { _filtroCliente = value ?? string.Empty; AplicarFiltros(); } }
    private string _filtroRubro = string.Empty;
    private string FiltroRubro { get => _filtroRubro; set { _filtroRubro = value ?? string.Empty; AplicarFiltros(); } }
    private string _filtroEstado = string.Empty;
    private string FiltroEstado { get => _filtroEstado; set { _filtroEstado = value ?? string.Empty; AplicarFiltros(); } }
    private string _filtroPago = string.Empty;
    private string FiltroPago { get => _filtroPago; set { _filtroPago = value ?? string.Empty; AplicarFiltros(); } }


    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task ToggleModoPapelera()
    {
        ModoPapelera = !ModoPapelera;
        LimpiarFiltros();
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            Cargando = true;
            Task<List<GET_PresupuestoDTO>?> presupuestosTask;

            if (ModoPapelera)
            {
                var service = (Zetta.Client.Servicios.PresupuestoService)PresupuestoService;
                presupuestosTask = service.GetInactivos();
            }
            else
            {
                presupuestosTask = PresupuestoService.GetAll();
            }

            var obrasTask = ObraService.GetAllAsync();

            await Task.WhenAll(presupuestosTask, obrasTask);

            PresupuestosOriginales = await presupuestosTask ?? new List<GET_PresupuestoDTO>();
            Obras = await obrasTask ?? new List<GET_ObraDTO>();

            AplicarFiltros();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "❌ Error al cargar datos.");
            PresupuestosOriginales = new List<GET_PresupuestoDTO>();
            Presupuestos = new List<GET_PresupuestoDTO>();
        }
        finally
        {
            Cargando = false;
        }
    }

    private (string Status, string BadgeClass) GetEstadoPresupuesto(GET_PresupuestoDTO p)
    {
        if (Obras.Any(o => o.PresupuestoId == p.Id)) return ("En Obra", "badge bg-primary");
        if (p.Aceptado) return ("Aceptado", "badge bg-success");
        if (int.TryParse(p.ValidacionDias, out int diasValidez) && p.FechaCreacion != default(DateTime))
        {
            var fechaVencimiento = p.FechaCreacion.Date.AddDays(diasValidez);
            if (DateTime.Today > fechaVencimiento) return ("Vencido", "badge bg-danger");
        }
        return ("Pendiente", "badge bg-secondary");
    }

    private void AbrirFormularioNuevo() => Navigation.NavigateTo("/presupuestos/nuevo");
    private void AbrirFormularioEdicion(int id) => Navigation.NavigateTo($"/presupuestos/editar/{id}");

    private async Task EliminarPresupuesto(int id)
    {
        if (Obras.Any(o => o.PresupuestoId == id))
        {
            await JSRuntime.InvokeVoidAsync("alert", "❌ No se puede eliminar un presupuesto asociado a una obra.");
            return;
        }
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Mover a papelera?"))
        {
            await PresupuestoService.Delete(id);
            await CargarDatos();
        }
    }

    private async Task RestaurarPresupuesto(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Restaurar presupuesto?"))
        {
            var service = (Zetta.Client.Servicios.PresupuestoService)PresupuestoService;
            await service.Restaurar(id);
            await CargarDatos();
            await JSRuntime.InvokeVoidAsync("alert", "✅ Presupuesto restaurado.");
        }
    }

    private async Task EliminarDefinitivo(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "⚠️ ¿ELIMINAR PARA SIEMPRE? Esta acción borrará permanentemente el presupuesto y sus detalles."))
        {
            var service = (Zetta.Client.Servicios.PresupuestoService)PresupuestoService;
            await service.EliminarDefinitivamente(id);
            await CargarDatos();
        }
    }

    private async Task GenerarPdfCliente(GET_PresupuestoDTO presupuesto)
    {
        if (presupuesto == null) return;
        if (presupuesto.ItemsDetalle == null || !presupuesto.ItemsDetalle.Any())
        {
            try
            {
                var fullPres = await PresupuestoService.GetById(presupuesto.Id);
                presupuesto.ItemsDetalle = fullPres?.ItemsDetalle;
            }
            catch { }
        }
        try { await JSRuntime.InvokeVoidAsync("generarPresupuestoPdf", presupuesto); }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("alert", $"❌ Error PDF: {ex.Message}"); }
    }

    private List<string> RubrosDisponibles => PresupuestosOriginales.Select(p => p.RubroNombre).Where(r => !string.IsNullOrWhiteSpace(r)).Distinct().OrderBy(p => p).ToList();

    private void AplicarFiltros()
    {
        if (PresupuestosOriginales == null) return;

        IEnumerable<GET_PresupuestoDTO> query = PresupuestosOriginales;
        if (!string.IsNullOrWhiteSpace(FiltroCliente)) { var s = FiltroCliente.Trim(); query = query.Where(p => !string.IsNullOrEmpty(p.NombreCliente) && p.NombreCliente.Contains(s, StringComparison.OrdinalIgnoreCase)); }
        if (!string.IsNullOrWhiteSpace(FiltroRubro)) query = query.Where(p => p.RubroNombre == FiltroRubro);
        if (!string.IsNullOrWhiteSpace(FiltroEstado)) query = query.Where(p => GetEstadoPresupuesto(p).Status == FiltroEstado);
        if (!string.IsNullOrWhiteSpace(FiltroPago)) query = query.Where(p => p.OpcionDePago.ToString() == FiltroPago);
        Presupuestos = query.ToList();
    }

    private void LimpiarFiltros()
    {
        _filtroCliente = ""; _filtroRubro = ""; _filtroEstado = ""; _filtroPago = "";
        AplicarFiltros();
    }

    private void VolverAlInicio() => Navigation.NavigateTo("/");
}